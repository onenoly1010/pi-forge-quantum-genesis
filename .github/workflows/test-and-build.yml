# Test and Build Workflow
# Runs on PR and push to feature branches
# Installs deps, runs linters, tests, builds, packaging verification, and uploads artifacts

name: Test and Build

on:
  push:
    branches:
      - '*'
      - '!main'
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: server/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r server/requirements.txt
          pip install flake8 pytest pytest-asyncio

      - name: Run linter (flake8)
        run: |
          flake8 server/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
          flake8 server/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run unit tests
        run: |
          cd tests
          python -m pytest -v --tb=short
        continue-on-error: true

  build-and-package:
    name: Build and Package
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r server/requirements.txt

      - name: Create build directory
        run: |
          mkdir -p build/pi-studio
          mkdir -p build/artifacts

      - name: Copy application files
        run: |
          # Copy server files
          cp -r server/ build/pi-studio/server/
          
          # Copy frontend files if they exist
          if [ -d "frontend" ]; then
            cp -r frontend/ build/pi-studio/frontend/
            echo "✓ Copied frontend directory"
          else
            echo "⚠ Frontend directory not found - skipping"
          fi
          
          # Copy API serverless functions (actual frontend)
          if [ -d "api" ]; then
            mkdir -p build/pi-studio/api
            cp -r api/ build/pi-studio/api/
            echo "✓ Copied API directory"
          fi
          
          # Copy root HTML/JS files
          cp index.html build/pi-studio/ || true
          cp pi-forge-integration.js build/pi-studio/ || true
          
          # Copy documentation
          mkdir -p build/pi-studio/docs
          cp -r docs/ build/pi-studio/docs/ || true
          
          # Copy configuration files
          cp railway.toml build/pi-studio/ || true
          cp railway.json build/pi-studio/ || true
          cp vercel.json build/pi-studio/ || true
          cp Dockerfile build/pi-studio/ || true
          
          # Copy README and config
          cp README.md build/pi-studio/ || true
          cp .env.example build/pi-studio/ || true
          
          # Create install script
          cat > build/pi-studio/install.sh << 'EOF'
          #!/bin/bash
          echo "Installing Pi Forge Quantum Genesis..."
          python -m venv venv
          source venv/bin/activate
          pip install -r server/requirements.txt
          echo "Installation complete!"
          echo "Run: source venv/bin/activate && python server/main.py"
          EOF
          chmod +x build/pi-studio/install.sh

      - name: Verify file sizes (1 MB limit)
        id: verify-sizes
        run: |
          echo "Verifying all files are under 1 MB..."
          OVERSIZED_FILES=""
          MAX_SIZE=$((1024 * 1024))  # 1 MB in bytes
          
          while IFS= read -r file; do
            size=$(stat -c %s "$file")
            if [ "$size" -gt "$MAX_SIZE" ]; then
              size_mb=$(echo "scale=2; $size / 1024 / 1024" | bc)
              OVERSIZED_FILES="${OVERSIZED_FILES}${file} (${size_mb} MB)\n"
              echo "⚠️ OVERSIZED: $file ($size_mb MB)"
            fi
          done < <(find build/pi-studio -type f)
          
          if [ -n "$OVERSIZED_FILES" ]; then
            echo "oversized=true" >> $GITHUB_OUTPUT
            echo "oversized_files<<EOF" >> $GITHUB_OUTPUT
            echo -e "$OVERSIZED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "❌ Found oversized files!"
          else
            echo "oversized=false" >> $GITHUB_OUTPUT
            echo "✅ All files are under 1 MB"
          fi

      - name: Create Pi Studio ZIP packages
        run: |
          cd build/pi-studio
          
          # Create main package
          zip -r ../artifacts/pi-studio-part-01.zip . \
            -x "*.exe" \
            -x "*.dll" \
            -x "__pycache__/*" \
            -x "*.pyc" \
            -x ".git/*" \
            -x ".venv/*" \
            -x "node_modules/*"
          
          echo "✅ Created pi-studio-part-01.zip"
          ls -lh ../artifacts/

      - name: Validate ZIP contents
        run: |
          echo "Validating ZIP contents..."
          cd build/artifacts
          
          for zipfile in pi-studio-*.zip; do
            echo "=== Checking $zipfile ==="
            unzip -l "$zipfile" | head -50
            
            # Check file sizes inside ZIP
            echo "Checking file sizes inside $zipfile..."
            mkdir -p temp_extract
            unzip -q "$zipfile" -d temp_extract
            
            MAX_SIZE=$((1024 * 1024))
            FAILED=false
            
            while IFS= read -r file; do
              size=$(stat -c %s "$file")
              if [ "$size" -gt "$MAX_SIZE" ]; then
                size_mb=$(echo "scale=2; $size / 1024 / 1024" | bc)
                echo "❌ OVERSIZED in ZIP: $file ($size_mb MB)"
                FAILED=true
              fi
            done < <(find temp_extract -type f)
            
            rm -rf temp_extract
            
            if [ "$FAILED" = true ]; then
              echo "❌ Validation FAILED for $zipfile"
              exit 1
            else
              echo "✅ All files in $zipfile are under 1 MB"
            fi
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pi-studio-packages
          path: build/artifacts/pi-studio-*.zip
          retention-days: 30

      - name: Generate build summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -lh build/artifacts/*.zip | while read line; do
            echo "- $line" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### File Count" >> $GITHUB_STEP_SUMMARY
          echo "Total files packaged: $(find build/pi-studio -type f | wc -l)" >> $GITHUB_STEP_SUMMARY

  health-check:
    name: API Health Check
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r server/requirements.txt

      - name: Start FastAPI server
        run: |
          cd server
          python -c "from main import app; print('FastAPI app loaded successfully')" || echo "FastAPI import check"
          
      - name: Start Flask server test
        run: |
          cd server
          python -c "from app import app; print('Flask app loaded successfully')" || echo "Flask import check"

      - name: Run health endpoint tests
        run: |
          # Test that the health check function works
          python -c "
          import sys
          sys.path.insert(0, 'server')
          try:
              from main import health_endpoint
              print('✅ Health endpoint function exists')
          except ImportError as e:
              print(f'⚠️ Could not import health_endpoint: {e}')
          "
