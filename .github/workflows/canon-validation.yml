name: Canon Validation

on:
  pull_request:
    paths:
      - 'canon/**'
  workflow_dispatch:
    inputs:
      artifact_path:
        description: 'Path to artifact to validate'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  validate-artifact:
    name: Validate Canon Artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r .github/scripts/requirements.txt

      - name: Get changed Canon files
        id: files
        uses: actions/github-script@v7
        with:
          script: |
            const artifact_path = context.payload.inputs?.artifact_path;
            
            if (artifact_path) {
              core.setOutput('artifact_paths', JSON.stringify([artifact_path]));
              return;
            }
            
            const pr_number = context.payload.pull_request?.number;
            if (!pr_number) {
              core.setFailed('No PR number or artifact path provided');
              return;
            }
            
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });
            
            const canonFiles = files
              .filter(f => f.filename.startsWith('canon/') && f.filename.endsWith('.md'))
              .filter(f => !f.filename.endsWith('INDEX.md') && !f.filename.endsWith('README.md'))
              .map(f => f.filename);
            
            core.setOutput('artifact_paths', JSON.stringify(canonFiles));

      - name: Validate artifacts
        id: validate
        run: |
          ARTIFACT_PATHS='${{ steps.files.outputs.artifact_paths }}'
          
          echo "Artifact paths to validate: $ARTIFACT_PATHS"
          
          ALL_PASSED=true
          RESULTS_FILE="/tmp/validation-results.json"
          echo '{"artifacts": []}' > "$RESULTS_FILE"
          
          for ARTIFACT in $(echo "$ARTIFACT_PATHS" | jq -r '.[]'); do
            echo "::group::Validating $ARTIFACT"
            
            if [ ! -f "$ARTIFACT" ]; then
              echo "::warning::Artifact not found: $ARTIFACT"
              continue
            fi
            
            RESULT_FILE="/tmp/validation-result-$(basename "$ARTIFACT" .md).json"
            
            if python .github/scripts/validate-artifact.py "$ARTIFACT" --output "$RESULT_FILE"; then
              echo "✅ Validation passed for $ARTIFACT"
            else
              echo "❌ Validation failed for $ARTIFACT"
              ALL_PASSED=false
            fi
            
            # Append to results
            if [ -f "$RESULT_FILE" ]; then
              jq ".artifacts += [$(cat "$RESULT_FILE")]" "$RESULTS_FILE" > "${RESULTS_FILE}.tmp"
              mv "${RESULTS_FILE}.tmp" "$RESULTS_FILE"
            fi
            
            echo "::endgroup::"
          done
          
          if [ "$ALL_PASSED" = true ]; then
            echo "all_passed=true" >> $GITHUB_OUTPUT
          else
            echo "all_passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: validation-results
          path: /tmp/validation-*.json
          if-no-files-found: ignore

      - name: Create check run
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = '/tmp/validation-results.json';
            
            let summary = '## Canon Artifact Validation\n\n';
            let conclusion = '${{ steps.validate.outputs.all_passed }}' === 'true' ? 'success' : 'failure';
            
            if (fs.existsSync(path)) {
              const results = JSON.parse(fs.readFileSync(path, 'utf8'));
              
              summary += `**Total Artifacts**: ${results.artifacts.length}\n\n`;
              
              for (const artifact of results.artifacts) {
                const icon = artifact.valid ? '✅' : '❌';
                summary += `### ${icon} ${artifact.file}\n\n`;
                
                if (artifact.issues && artifact.issues.length > 0) {
                  const errors = artifact.issues.filter(i => i.severity === 'error');
                  const warnings = artifact.issues.filter(i => i.severity === 'warning');
                  
                  if (errors.length > 0) {
                    summary += `**Errors**: ${errors.length}\n`;
                    for (const error of errors) {
                      summary += `- ❌ ${error.type}: ${error.message}\n`;
                    }
                    summary += '\n';
                  }
                  
                  if (warnings.length > 0) {
                    summary += `**Warnings**: ${warnings.length}\n`;
                    for (const warning of warnings) {
                      summary += `- ⚠️  ${warning.type}: ${warning.message}\n`;
                    }
                    summary += '\n';
                  }
                } else {
                  summary += '✅ No issues found\n\n';
                }
              }
            }
            
            const pr_number = context.payload.pull_request?.number;
            if (pr_number) {
              await github.rest.checks.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'Canon Artifact Validation',
                head_sha: context.payload.pull_request.head.sha,
                status: 'completed',
                conclusion: conclusion,
                output: {
                  title: 'Canon Artifact Validation',
                  summary: summary
                }
              });
            }

      - name: Comment on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = '/tmp/validation-results.json';
            
            if (!fs.existsSync(path)) {
              return;
            }
            
            const results = JSON.parse(fs.readFileSync(path, 'utf8'));
            const allPassed = '${{ steps.validate.outputs.all_passed }}' === 'true';
            
            let comment = allPassed 
              ? '✅ **Canon Artifact Validation Passed**\n\n'
              : '❌ **Canon Artifact Validation Failed**\n\n';
            
            comment += `Validated ${results.artifacts.length} artifact(s)\n\n`;
            
            for (const artifact of results.artifacts) {
              const icon = artifact.valid ? '✅' : '❌';
              comment += `${icon} \`${artifact.file}\`\n`;
              
              if (!artifact.valid && artifact.issues) {
                const errors = artifact.issues.filter(i => i.severity === 'error');
                if (errors.length > 0) {
                  comment += `  - ${errors.length} error(s) found\n`;
                }
              }
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });

      - name: Fail if validation failed
        if: steps.validate.outputs.all_passed != 'true'
        run: |
          echo "❌ One or more artifacts failed validation"
          exit 1
