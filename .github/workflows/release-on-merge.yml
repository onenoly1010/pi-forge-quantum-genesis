# Release on Merge Workflow
# Runs on push to main (merged PR)
# Builds, packages, creates Draft Release with pi-studio zips and press-release

name: Release on Merge

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  build-and-release:
    name: Build and Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r server/requirements.txt

      - name: Create build directory
        run: |
          mkdir -p build/pi-studio
          mkdir -p build/artifacts

      - name: Copy application files
        run: |
          # Copy server files
          cp -r server/ build/pi-studio/server/
          
          # Copy frontend files
          cp -r frontend/ build/pi-studio/frontend/
          
          # Copy root HTML/JS files
          cp index.html build/pi-studio/ || true
          cp pi-forge-integration.js build/pi-studio/ || true
          
          # Copy documentation
          mkdir -p build/pi-studio/docs
          cp -r docs/ build/pi-studio/docs/ || true
          
          # Copy configuration files
          cp railway.toml build/pi-studio/ || true
          cp railway.json build/pi-studio/ || true
          cp vercel.json build/pi-studio/ || true
          cp Dockerfile build/pi-studio/ || true
          
          # Copy README and config
          cp README.md build/pi-studio/ || true
          cp .env.example build/pi-studio/ || true
          
          # Create install script
          cat > build/pi-studio/install.sh << 'EOF'
          #!/bin/bash
          echo "Installing Pi Forge Quantum Genesis..."
          python -m venv venv
          source venv/bin/activate
          pip install -r server/requirements.txt
          echo "Installation complete!"
          echo "Run: source venv/bin/activate && python server/main.py"
          EOF
          chmod +x build/pi-studio/install.sh

      - name: Create Pi Studio ZIP packages
        run: |
          cd build/pi-studio
          
          # Create main package (exclude large binaries)
          zip -r ../artifacts/pi-studio-part-01.zip . \
            -x "*.exe" \
            -x "*.dll" \
            -x "__pycache__/*" \
            -x "*.pyc" \
            -x ".git/*" \
            -x ".venv/*" \
            -x "node_modules/*"
          
          echo "✅ Created pi-studio-part-01.zip"

      - name: Validate ZIP contents (1 MB per file limit)
        run: |
          echo "Validating ZIP contents..."
          cd build/artifacts
          
          VALIDATION_PASSED=true
          OVERSIZED_REPORT=""
          
          for zipfile in pi-studio-*.zip; do
            echo "=== Checking $zipfile ==="
            mkdir -p temp_extract
            unzip -q "$zipfile" -d temp_extract
            
            MAX_SIZE=$((1024 * 1024))
            
            while IFS= read -r file; do
              size=$(stat -c %s "$file")
              if [ "$size" -gt "$MAX_SIZE" ]; then
                size_mb=$(echo "scale=2; $size / 1024 / 1024" | bc)
                echo "❌ OVERSIZED: $file ($size_mb MB)"
                OVERSIZED_REPORT="${OVERSIZED_REPORT}- ${file} (${size_mb} MB)\n"
                VALIDATION_PASSED=false
              fi
            done < <(find temp_extract -type f)
            
            rm -rf temp_extract
          done
          
          if [ "$VALIDATION_PASSED" = false ]; then
            echo "::error::Found files exceeding 1 MB limit"
            echo "$OVERSIZED_REPORT" > oversized_report.txt
            exit 1
          fi
          
          echo "✅ All files pass size validation"

      - name: Generate version tag
        id: version
        run: |
          # Generate version based on date and short SHA
          VERSION="v$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Generate press release draft
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DATE=$(date +"%B %d, %Y")
          
          cat > build/artifacts/press-release-draft.md << EOF
          # Pi Forge Quantum Genesis - Release $VERSION
          
          **Release Date:** $DATE
          
          ## Summary
          
          Pi Forge Quantum Genesis is an ethical AI application builder for the Pi Network ecosystem. This release includes the complete production-ready package with all frontend and backend components.
          
          ## Highlights
          
          - ✅ **Quantum Resonance Lattice**: Full multi-application architecture with FastAPI, Flask, and Gradio
          - ✅ **Ethical AI Audit System**: Automated compliance checking for responsible AI development
          - ✅ **Pi Network Integration**: Complete payment processing and blockchain integration
          - ✅ **Real-time WebSocket Communication**: Live telemetry and consciousness streaming
          - ✅ **Cyber Samurai Guardian**: Advanced security monitoring and threat detection
          - ✅ **dApp Creation Engine**: Build and deploy decentralized applications
          - ✅ **Governance System**: Community-driven proposal and voting system
          
          ## Package Contents
          
          - \`pi-studio-part-01.zip\`: Core application package
            - Server components (FastAPI, Flask, Gradio)
            - Frontend assets and integration scripts
            - Documentation and configuration files
            - Installation scripts
          
          ## Installation
          
          1. Download the pi-studio package(s)
          2. Extract to your desired location
          3. Run \`./install.sh\` (Linux/Mac) or follow README instructions (Windows)
          4. Configure environment variables (copy .env.example to .env)
          5. Start the server with \`python server/main.py\`
          
          ## Requirements
          
          - Python 3.11 or higher
          - pip package manager
          - Node.js (optional, for frontend development)
          
          ## Publication Checklist
          
          - [ ] Review release notes for accuracy
          - [ ] Verify all artifacts are attached
          - [ ] Test installation process
          - [ ] Update documentation if needed
          - [ ] Notify community channels
          - [ ] Publish release
          
          ---
          
          *Built with Quantum Spirit by Kris Olofson (onenoly1010)*
          *Pi Forge Quantum Genesis 2024-2025*
          EOF
          
          echo "✅ Press release draft generated"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Pi Forge Quantum Genesis ${{ steps.version.outputs.version }}"
          body_path: build/artifacts/press-release-draft.md
          draft: true
          files: |
            build/artifacts/pi-studio-*.zip
            build/artifacts/press-release-draft.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate release summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Created" >> $GITHUB_STEP_SUMMARY
          ls -lh build/artifacts/ | while read line; do
            echo "- $line" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status: Draft Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ **Action Required**: Review and publish the draft release manually" >> $GITHUB_STEP_SUMMARY
