# Mainnet Smoke Guardian - Approval Watcher
# This workflow safely gates and dispatches protected Mainnet smoke guardian runs
# Manual/dispatch only - requires secrets to be configured

name: Mainnet Smoke Guardian

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment for smoke test'
        required: true
        default: 'mainnet'
        type: choice
        options:
          - mainnet
          - testnet
      dry_run:
        description: 'Run in dry-run mode (no actual transactions)'
        required: true
        default: true
        type: boolean
      approval_reference:
        description: 'Approval reference ID (optional tracking)'
        required: false
        type: string

# Ensure only one mainnet deployment runs at a time
concurrency:
  group: mainnet-smoke-guardian-${{ github.ref }}
  cancel-in-progress: false

# Minimal permissions for security
permissions:
  contents: read

jobs:
  validate-secrets:
    name: Validate Required Secrets
    runs-on: ubuntu-latest
    outputs:
      secrets_valid: ${{ steps.check.outputs.valid }}
    steps:
      - name: Check required secrets are configured
        id: check
        run: |
          MISSING_SECRETS=""
          
          if [ -z "${{ secrets.MAINNET_API_KEY }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}MAINNET_API_KEY "
          fi
          
          if [ -z "${{ secrets.GUARDIAN_TOKEN }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}GUARDIAN_TOKEN "
          fi
          
          if [ -n "$MISSING_SECRETS" ]; then
            echo "::error::Missing required secrets: $MISSING_SECRETS"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "All required secrets are configured"
          echo "valid=true" >> $GITHUB_OUTPUT

  approval-gate:
    name: Mainnet Approval Gate
    runs-on: ubuntu-latest
    needs: validate-secrets
    if: needs.validate-secrets.outputs.secrets_valid == 'true'
    environment:
      name: mainnet-protected
    steps:
      - name: Approval checkpoint
        run: |
          echo "âœ… Mainnet deployment approved"
          echo "Environment: ${{ inputs.environment }}"
          echo "Dry Run: ${{ inputs.dry_run }}"
          echo "Approval Reference: ${{ inputs.approval_reference || 'N/A' }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

  smoke-guardian:
    name: Execute Smoke Guardian
    runs-on: ubuntu-latest
    needs: [validate-secrets, approval-gate]
    if: |
      always() &&
      needs.validate-secrets.outputs.secrets_valid == 'true' &&
      needs.approval-gate.result == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f server/requirements.txt ]; then
            pip install -r server/requirements.txt
          fi

      - name: Run Mainnet Smoke Tests
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          DRY_RUN: ${{ inputs.dry_run }}
          # Secrets are referenced but not exposed in logs
          MAINNET_API_KEY: ${{ secrets.MAINNET_API_KEY }}
          GUARDIAN_TOKEN: ${{ secrets.GUARDIAN_TOKEN }}
        run: |
          echo "ðŸ”¥ Starting Mainnet Smoke Guardian"
          echo "=================================="
          echo "Environment: ${ENVIRONMENT}"
          echo "Dry Run Mode: ${DRY_RUN}"
          echo ""
          
          if [ "${DRY_RUN}" = "true" ]; then
            echo "â„¹ï¸  Running in DRY-RUN mode - no actual transactions will be made"
          fi
          
          # Verify secrets are available (without exposing them)
          if [ -n "${MAINNET_API_KEY}" ] && [ -n "${GUARDIAN_TOKEN}" ]; then
            echo "âœ… Credentials verified"
          else
            echo "âŒ Missing credentials"
            exit 1
          fi
          
          echo ""
          echo "ðŸƒ Executing smoke test suite..."
          # Add actual smoke test commands here
          # Example: python scripts/smoke_test.py --env ${ENVIRONMENT}
          
          echo ""
          echo "âœ… Smoke Guardian completed successfully"

      - name: Generate Summary
        if: always()
        run: |
          echo "## Mainnet Smoke Guardian Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${{ inputs.dry_run }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered By | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Run ID | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Approval Ref | ${{ inputs.approval_reference || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
