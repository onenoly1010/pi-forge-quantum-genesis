#!/usr/bin/env python3
"""
ğŸŒŒ Sacred Trinity Quick Analysis
Lightweight evaluation and optimization analysis for Quantum Resonance Lattice
"""

import os
import json
from datetime import datetime
from pathlib import Path

class QuickSacredTrinityAnalyzer:
    """Quick analysis of Sacred Trinity architecture without external dependencies"""
    
    def __init__(self, workspace_root=".."):
        self.workspace_root = Path(workspace_root)
        self.analysis_results = {}
        
    def analyze_architecture(self):
        """Analyze Sacred Trinity architecture completeness"""
        print("ğŸŒŒ Sacred Trinity Architecture Analysis")
        print("="*50)
        
        # Check core components
        components = self._analyze_components()
        configuration = self._analyze_configuration()
        frontend = self._analyze_frontend()
        dependencies = self._analyze_dependencies()
        
        # Calculate overall score
        overall_score = self._calculate_overall_score(components, configuration, frontend, dependencies)
        
        # Generate recommendations
        recommendations = self._generate_recommendations(components, configuration, frontend, dependencies)
        
        # Create analysis report
        self.analysis_results = {
            "timestamp": datetime.utcnow().isoformat(),
            "architecture_analysis": {
                "components": components,
                "configuration": configuration,
                "frontend": frontend,
                "dependencies": dependencies
            },
            "overall_score": overall_score,
            "recommendations": recommendations
        }
        
        return self.analysis_results
    
    def _analyze_components(self):
        """Analyze Sacred Trinity components (FastAPI, Flask, Gradio)"""
        print("ğŸ” Analyzing Sacred Trinity Components...")
        
        components = {
            "fastapi": {
                "file": "server/main.py",
                "status": "âŒ",
                "features": [],
                "completeness": 0
            },
            "flask": {
                "file": "server/app.py", 
                "status": "âŒ",
                "features": [],
                "completeness": 0
            },
            "gradio": {
                "file": "server/canticle_interface.py",
                "status": "âŒ",
                "features": [],
                "completeness": 0
            }
        }\n        \n        # Analyze FastAPI (main.py)\n        fastapi_file = self.workspace_root / \"server\" / \"main.py\"\n        if fastapi_file.exists():\n            content = fastapi_file.read_text()\n            components[\"fastapi\"][\"status\"] = \"âœ…\"\n            \n            # Check key FastAPI features\n            fastapi_features = [\n                (\"FastAPI app creation\", \"FastAPI(\" in content),\n                (\"WebSocket support\", \"/ws/\" in content or \"WebSocket\" in content),\n                (\"Supabase integration\", \"supabase\" in content.lower()),\n                (\"JWT authentication\", \"jwt\" in content.lower() or \"auth\" in content.lower()),\n                (\"CORS middleware\", \"cors\" in content.lower())\n            ]\n            \n            for feature_name, has_feature in fastapi_features:\n                if has_feature:\n                    components[\"fastapi\"][\"features\"].append(feature_name)\n            \n            components[\"fastapi\"][\"completeness\"] = len(components[\"fastapi\"][\"features\"]) / len(fastapi_features)\n        \n        # Analyze Flask (app.py) \n        flask_file = self.workspace_root / \"server\" / \"app.py\"\n        if flask_file.exists():\n            content = flask_file.read_text()\n            components[\"flask\"][\"status\"] = \"âœ…\"\n            \n            # Check key Flask features\n            flask_features = [\n                (\"Flask app creation\", \"Flask(\" in content),\n                (\"Dashboard routes\", \"/dashboard\" in content or \"/resonance\" in content),\n                (\"CORS support\", \"cors\" in content.lower()),\n                (\"Quantum engine\", \"quantum\" in content.lower()),\n                (\"Template rendering\", \"render_template\" in content)\n            ]\n            \n            for feature_name, has_feature in flask_features:\n                if has_feature:\n                    components[\"flask\"][\"features\"].append(feature_name)\n            \n            components[\"flask\"][\"completeness\"] = len(components[\"flask\"][\"features\"]) / len(flask_features)\n        \n        # Analyze Gradio (canticle_interface.py)\n        gradio_file = self.workspace_root / \"server\" / \"canticle_interface.py\" \n        if gradio_file.exists():\n            content = gradio_file.read_text()\n            components[\"gradio\"][\"status\"] = \"âœ…\"\n            \n            # Check key Gradio features\n            gradio_features = [\n                (\"Gradio interface\", \"gradio\" in content.lower() or \"gr.\" in content),\n                (\"Ethical audit function\", \"ethical\" in content.lower()),\n                (\"Interface launch\", \"launch\" in content.lower()),\n                (\"Audit processing\", \"audit\" in content.lower()),\n                (\"Coherence scoring\", \"coherence\" in content.lower())\n            ]\n            \n            for feature_name, has_feature in gradio_features:\n                if has_feature:\n                    components[\"gradio\"][\"features\"].append(feature_name)\n            \n            components[\"gradio\"][\"completeness\"] = len(components[\"gradio\"][\"features\"]) / len(gradio_features)\n        \n        print(f\"   FastAPI: {components['fastapi']['status']} ({len(components['fastapi']['features'])} features)\")\n        print(f\"   Flask: {components['flask']['status']} ({len(components['flask']['features'])} features)\")\n        print(f\"   Gradio: {components['gradio']['status']} ({len(components['gradio']['features'])} features)\")\n        \n        return components\n    \n    def _analyze_configuration(self):\n        \"\"\"Analyze configuration files and deployment setup\"\"\"\n        print(\"âš™ï¸ Analyzing Configuration...\")\n        \n        config = {\n            \"dockerfile\": {\"status\": \"âŒ\", \"optimized\": False},\n            \"railway_config\": {\"status\": \"âŒ\", \"optimized\": False}, \n            \"requirements\": {\"status\": \"âŒ\", \"dependencies_count\": 0},\n            \"env_template\": {\"status\": \"âŒ\", \"has_supabase\": False}\n        }\n        \n        # Check Dockerfile\n        dockerfile = self.workspace_root / \"Dockerfile\"\n        if dockerfile.exists():\n            content = dockerfile.read_text()\n            config[\"dockerfile\"][\"status\"] = \"âœ…\"\n            config[\"dockerfile\"][\"optimized\"] = \"python:3.11-slim\" in content and \"COPY server/\" in content\n        \n        # Check Railway configuration\n        railway_config = self.workspace_root / \"railway.toml\"\n        if railway_config.exists():\n            content = railway_config.read_text()\n            config[\"railway_config\"][\"status\"] = \"âœ…\"\n            config[\"railway_config\"][\"optimized\"] = \"DOCKERFILE\" in content\n        \n        # Check requirements.txt\n        requirements_file = self.workspace_root / \"server\" / \"requirements.txt\"\n        if requirements_file.exists():\n            content = requirements_file.read_text()\n            config[\"requirements\"][\"status\"] = \"âœ…\"\n            config[\"requirements\"][\"dependencies_count\"] = len([line for line in content.splitlines() if line.strip() and not line.startswith(\"#\")])\n        \n        # Check for .env template\n        env_files = [self.workspace_root / \".env\", self.workspace_root / \".env.template\", self.workspace_root / \"README.md\"]\n        for env_file in env_files:\n            if env_file.exists() and \"SUPABASE\" in env_file.read_text():\n                config[\"env_template\"][\"status\"] = \"âœ…\"\n                config[\"env_template\"][\"has_supabase\"] = True\n                break\n        \n        print(f\"   Dockerfile: {config['dockerfile']['status']}\")\n        print(f\"   Railway Config: {config['railway_config']['status']}\")\n        print(f\"   Requirements: {config['requirements']['status']} ({config['requirements']['dependencies_count']} dependencies)\")\n        print(f\"   Environment: {config['env_template']['status']}\")\n        \n        return config\n    \n    def _analyze_frontend(self):\n        \"\"\"Analyze frontend integration\"\"\"\n        print(\"ğŸ¨ Analyzing Frontend Integration...\")\n        \n        frontend = {\n            \"html_files\": {\"count\": 0, \"status\": \"âŒ\"},\n            \"pi_integration\": {\"status\": \"âŒ\", \"features\": []},\n            \"resonance_viz\": {\"status\": \"âŒ\", \"svg_support\": False}\n        }\n        \n        frontend_dir = self.workspace_root / \"frontend\"\n        if frontend_dir.exists():\n            html_files = list(frontend_dir.glob(\"*.html\"))\n            frontend[\"html_files\"][\"count\"] = len(html_files)\n            frontend[\"html_files\"][\"status\"] = \"âœ…\" if html_files else \"âŒ\"\n            \n            # Check Pi integration\n            pi_integration_file = frontend_dir / \"pi-forge-integration.js\"\n            if pi_integration_file.exists():\n                content = pi_integration_file.read_text()\n                frontend[\"pi_integration\"][\"status\"] = \"âœ…\"\n                \n                pi_features = [\n                    (\"Pi Network SDK\", \"Pi.\" in content),\n                    (\"Payment processing\", \"createPayment\" in content),\n                    (\"SVG visualization\", \"SVG\" in content or \"svg\" in content),\n                    (\"Resonance rendering\", \"resonance\" in content.lower()),\n                    (\"WebSocket integration\", \"websocket\" in content.lower())\n                ]\n                \n                for feature_name, has_feature in pi_features:\n                    if has_feature:\n                        frontend[\"pi_integration\"][\"features\"].append(feature_name)\n            \n            # Check for SVG/visualization support\n            for html_file in html_files:\n                content = html_file.read_text()\n                if \"svg\" in content.lower() or \"visualization\" in content.lower():\n                    frontend[\"resonance_viz\"][\"status\"] = \"âœ…\"\n                    frontend[\"resonance_viz\"][\"svg_support\"] = True\n                    break\n        \n        print(f\"   HTML Files: {frontend['html_files']['status']} ({frontend['html_files']['count']} files)\")\n        print(f\"   Pi Integration: {frontend['pi_integration']['status']} ({len(frontend['pi_integration']['features'])} features)\")\n        print(f\"   Resonance Viz: {frontend['resonance_viz']['status']}\")\n        \n        return frontend\n    \n    def _analyze_dependencies(self):\n        \"\"\"Analyze dependencies and evaluation framework\"\"\"\n        print(\"ğŸ“¦ Analyzing Dependencies and Evaluation...\")\n        \n        dependencies = {\n            \"evaluation_system\": {\"status\": \"âŒ\", \"azure_ai\": False},\n            \"agent_runner\": {\"status\": \"âŒ\", \"async_support\": False},\n            \"tracing_system\": {\"status\": \"âŒ\", \"observability\": False}\n        }\n        \n        # Check evaluation system\n        eval_file = self.workspace_root / \"server\" / \"evaluation_system.py\"\n        if eval_file.exists():\n            content = eval_file.read_text()\n            dependencies[\"evaluation_system\"][\"status\"] = \"âœ…\"\n            dependencies[\"evaluation_system\"][\"azure_ai\"] = \"azure-ai-evaluation\" in content\n        \n        # Check agent runner\n        runner_file = self.workspace_root / \"server\" / \"quantum_agent_runner.py\"\n        if runner_file.exists():\n            content = runner_file.read_text()\n            dependencies[\"agent_runner\"][\"status\"] = \"âœ…\"\n            dependencies[\"agent_runner\"][\"async_support\"] = \"async\" in content\n        \n        # Check tracing system\n        tracing_file = self.workspace_root / \"server\" / \"tracing_system.py\"\n        if tracing_file.exists():\n            dependencies[\"tracing_system\"][\"status\"] = \"âœ…\"\n            dependencies[\"tracing_system\"][\"observability\"] = \"trace\" in tracing_file.read_text().lower()\n        \n        print(f\"   Evaluation System: {dependencies['evaluation_system']['status']}\")\n        print(f\"   Agent Runner: {dependencies['agent_runner']['status']}\")\n        print(f\"   Tracing System: {dependencies['tracing_system']['status']}\")\n        \n        return dependencies\n    \n    def _calculate_overall_score(self, components, configuration, frontend, dependencies):\n        \"\"\"Calculate overall architecture score\"\"\"\n        scores = []\n        \n        # Component scores (40% weight)\n        component_completeness = [\n            components[\"fastapi\"][\"completeness\"],\n            components[\"flask\"][\"completeness\"],\n            components[\"gradio\"][\"completeness\"]\n        ]\n        component_score = sum(component_completeness) / len(component_completeness)\n        scores.append(component_score * 0.4)\n        \n        # Configuration score (25% weight)\n        config_items = [config for config in configuration.values()]\n        config_score = sum(1 for item in config_items if item[\"status\"] == \"âœ…\") / len(config_items)\n        scores.append(config_score * 0.25)\n        \n        # Frontend score (20% weight)\n        frontend_score = (\n            (1 if frontend[\"html_files\"][\"status\"] == \"âœ…\" else 0) +\n            (1 if frontend[\"pi_integration\"][\"status\"] == \"âœ…\" else 0) +\n            (1 if frontend[\"resonance_viz\"][\"status\"] == \"âœ…\" else 0)\n        ) / 3\n        scores.append(frontend_score * 0.2)\n        \n        # Dependencies score (15% weight)\n        deps_score = sum(1 for dep in dependencies.values() if dep[\"status\"] == \"âœ…\") / len(dependencies)\n        scores.append(deps_score * 0.15)\n        \n        overall = sum(scores)\n        return {\n            \"overall_score\": overall,\n            \"overall_percentage\": round(overall * 100, 1),\n            \"component_score\": component_score,\n            \"config_score\": config_score, \n            \"frontend_score\": frontend_score,\n            \"dependencies_score\": deps_score,\n            \"rating\": self._get_rating(overall)\n        }\n    \n    def _get_rating(self, score):\n        \"\"\"Get performance rating based on score\"\"\"\n        if score >= 0.9:\n            return {\"level\": \"Transcendent\", \"emoji\": \"ğŸŒŸ\", \"description\": \"Sacred Trinity achieving perfect quantum harmony\"}\n        elif score >= 0.75:\n            return {\"level\": \"Harmonic\", \"emoji\": \"âœ¨\", \"description\": \"Sacred Trinity maintaining excellent resonance\"}\n        elif score >= 0.6:\n            return {\"level\": \"Growing\", \"emoji\": \"ğŸŒ±\", \"description\": \"Sacred Trinity building strong foundations\"}\n        elif score >= 0.4:\n            return {\"level\": \"Foundation\", \"emoji\": \"ğŸ”§\", \"description\": \"Sacred Trinity requires optimization\"}\n        else:\n            return {\"level\": \"Initiation\", \"emoji\": \"âš¡\", \"description\": \"Sacred Trinity needs significant development\"}\n    \n    def _generate_recommendations(self, components, configuration, frontend, dependencies):\n        \"\"\"Generate optimization recommendations\"\"\"\n        recommendations = []\n        \n        # Component recommendations\n        for comp_name, comp_data in components.items():\n            if comp_data[\"status\"] == \"âŒ\":\n                recommendations.append(f\"ğŸ”§ {comp_name.title()} component missing - create {comp_data['file']}\")\n            elif comp_data[\"completeness\"] < 0.8:\n                recommendations.append(f\"âš¡ {comp_name.title()} component needs enhancement - add missing features\")\n        \n        # Configuration recommendations\n        if configuration[\"dockerfile\"][\"status\"] == \"âŒ\":\n            recommendations.append(\"ğŸ³ Add Dockerfile for containerized deployment\")\n        elif not configuration[\"dockerfile\"][\"optimized\"]:\n            recommendations.append(\"ğŸ³ Optimize Dockerfile for multi-stage builds and slim images\")\n        \n        if configuration[\"railway_config\"][\"status\"] == \"âŒ\":\n            recommendations.append(\"ğŸš‚ Add railway.toml for Railway deployment configuration\")\n        \n        if configuration[\"requirements\"][\"dependencies_count\"] < 10:\n            recommendations.append(\"ğŸ“¦ Consider adding more dependencies for comprehensive functionality\")\n        \n        if not configuration[\"env_template\"][\"has_supabase\"]:\n            recommendations.append(\"ğŸ”‘ Add Supabase environment configuration template\")\n        \n        # Frontend recommendations\n        if frontend[\"html_files\"][\"count\"] == 0:\n            recommendations.append(\"ğŸ¨ Create frontend HTML interfaces for user interaction\")\n        \n        if frontend[\"pi_integration\"][\"status\"] == \"âŒ\":\n            recommendations.append(\"ğŸ’° Implement Pi Network integration for payment processing\")\n        \n        if not frontend[\"resonance_viz\"][\"svg_support\"]:\n            recommendations.append(\"ğŸŒˆ Add SVG visualization support for quantum resonance\")\n        \n        # Dependencies recommendations\n        if dependencies[\"evaluation_system\"][\"status\"] == \"âŒ\":\n            recommendations.append(\"ğŸ“Š Implement evaluation system for performance monitoring\")\n        \n        if dependencies[\"agent_runner\"][\"status\"] == \"âŒ\":\n            recommendations.append(\"ğŸ¤– Create agent runner for automated testing and response collection\")\n        \n        if dependencies[\"tracing_system\"][\"status\"] == \"âŒ\":\n            recommendations.append(\"ğŸ” Add tracing system for observability and debugging\")\n        \n        # Add positive reinforcement if doing well\n        overall_score = self._calculate_overall_score(components, configuration, frontend, dependencies)[\"overall_score\"]\n        if overall_score >= 0.8:\n            recommendations.insert(0, \"ğŸŒŸ Sacred Trinity demonstrating excellent architecture - continue optimization\")\n        elif overall_score >= 0.6:\n            recommendations.insert(0, \"âœ¨ Sacred Trinity showing strong foundation - focus on enhancement areas\")\n        \n        return recommendations\n    \n    def print_report(self):\n        \"\"\"Print comprehensive analysis report\"\"\"\n        results = self.analysis_results\n        \n        print(\"\\n\" + \"=\"*60)\n        print(\"ğŸŒŒ SACRED TRINITY ARCHITECTURE ANALYSIS REPORT\")\n        print(\"=\"*60)\n        \n        # Overall score\n        score_data = results[\"overall_score\"]\n        rating = score_data[\"rating\"]\n        \n        print(f\"\\nğŸ¯ OVERALL PERFORMANCE: {score_data['overall_percentage']}%\")\n        print(f\"   {rating['emoji']} Rating: {rating['level']}\")\n        print(f\"   {rating['description']}\")\n        \n        # Detailed scores\n        print(f\"\\nğŸ“Š DETAILED SCORES:\")\n        print(f\"   ğŸ§  Components: {round(score_data['component_score'] * 100, 1)}%\")\n        print(f\"   âš™ï¸ Configuration: {round(score_data['config_score'] * 100, 1)}%\")\n        print(f\"   ğŸ¨ Frontend: {round(score_data['frontend_score'] * 100, 1)}%\")\n        print(f\"   ğŸ“¦ Dependencies: {round(score_data['dependencies_score'] * 100, 1)}%\")\n        \n        # Component status\n        print(f\"\\nğŸ§  SACRED TRINITY COMPONENTS:\")\n        components = results[\"architecture_analysis\"][\"components\"]\n        for comp_name, comp_data in components.items():\n            print(f\"   {comp_name.title()}: {comp_data['status']} ({len(comp_data['features'])} features)\")\n        \n        # Recommendations\n        recommendations = results[\"recommendations\"]\n        if recommendations:\n            print(f\"\\nğŸ”§ OPTIMIZATION RECOMMENDATIONS:\")\n            for i, rec in enumerate(recommendations[:8], 1):  # Show top 8\n                print(f\"   {i}. {rec}\")\n        \n        print(f\"\\nğŸ“„ Analysis completed at: {results['timestamp']}\")\n        print(\"âœ… Sacred Trinity analysis complete!\")\n    \n    def save_report(self, filename=\"sacred_trinity_analysis.json\"):\n        \"\"\"Save analysis report to JSON file\"\"\"\n        with open(filename, 'w') as f:\n            json.dump(self.analysis_results, f, indent=2)\n        print(f\"\\nğŸ’¾ Analysis report saved to: {filename}\")\n        return filename\n\ndef main():\n    \"\"\"Main analysis function\"\"\"\n    print(\"ğŸŒŒ Sacred Trinity Quick Analysis & Optimization Tool\")\n    print(\"ğŸ¯ Analyzing Quantum Resonance Lattice Architecture...\\n\")\n    \n    # Initialize analyzer\n    analyzer = QuickSacredTrinityAnalyzer()\n    \n    # Run analysis\n    results = analyzer.analyze_architecture()\n    \n    # Print comprehensive report\n    analyzer.print_report()\n    \n    # Save report\n    report_file = analyzer.save_report()\n    \n    return results\n\nif __name__ == \"__main__\":\n    main()\n